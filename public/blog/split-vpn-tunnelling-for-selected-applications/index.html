<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wolfgang&#x27;s Blog</title>
    <link rel="stylesheet" href="https://notthebe.ee/style.css?h=7e75e128266ca4b080dae13fc9815d098fa566385bc458ecc207c338f9f5b24c" />
    <link rel="shortcut icon" type="image/png" href="https://notthebe.ee/favicon.png"/>
    <script
      src="https://kit.fontawesome.com/93866eaaa9.js"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Open+Sans:ital,wght@0,400;0,600;1,400;1,600&display=swap"
      rel="stylesheet"
    />
  </head>

    <nav class="menu">
      <div class="nav-left">
        <ul>
          <li>
            <a href="/"
              ><img class="logo" src="https://notthebe.ee/favicon.png" alt="" /><span
                class="sitename"
                >wolfgang&#x27;s blog</span
              ></a
            >
          </li>
        </ul>
      </div>
      <div class="nav-right">
        <ul>
          <li style="padding: 9px">
            <a
              id="darkmodetoggle"
              class="fas fa-moon"
              onclick="switchTheme()"
            ></a>
          </li>
          <li><a href="mailto:wolfgangschannel@mailbox.org">contact</a></li>
          <li><a href="impressum.html">impressum</a></li>
          <li><a target="_blank" href="https://patreon.com/WolfgangsChannel">patreon</a></li>
          <li><a target="_blank" href="https://github.com/notthebee">github</a></li>
          <li><a target="_blank" href="https://twitter.com/notthebeeee">twitter</a></li>
          <li><a target="_blank" href="https://youtube.com/c/WolfgangsChannel">videos</a></li>
        </ul>
      </div>
    </nav>

  <body>
    <section class="section">
      <div class="container">
<h1 class="title">
  Split VPN tunelling for selected applications (Windows, Linux, macOS)
</h1>
<p class="date">2020-11-11</p>
<p><div class="post__image">
    <a href="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/screenshot.png" class="image-link" target="_blank">
        <img src="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/screenshot.png" alt="docker-compose.yml">
    </a>
</div>

Sometimes you need to use VPN for a few selected applications, but not for your whole Internet traffic. However, most operating systems do not include that functionality. </p>
<p>In this tutorial we will create a local proxy for our VPN using Docker and <a href="https://hub.docker.com/r/binhex/arch-delugevpn">binhex/arch-delugevpn</a></p>
<h2 id="windows">Windows</h2>
<h3 id="installing-wsl2">Installing WSL2</h3>
<p><strong>IMPORTANT:</strong> At the moment of writing, Microsoft's version of the Linux kernel does not include the Wireguard module by default. You can try your luck by compiling the kernel and the module manually, but I didn't manage to make it work on my machine. Hence, I recommend using OpenVPN with Windows.</p>
<p>Open the start menu and type “Turn&quot;. Click on the first result, <strong>Turn Windows features on or off</strong>. Here we need to enable two things — <strong>Virtual Machine Platform</strong> and <strong>Windows Subsystem for Linux</strong>.</p>
<div class="post__image">
    <a href="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/features.png" class="image-link" target="_blank">
        <img src="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/features.png" alt="Turn Windows features on or off">
    </a>
</div>
<p>You can also do the same by typing the following commands in Powershell:</p>
<pre data-lang="powershell" style="background-color:#2b303b;color:#c0c5ce;" class="language-powershell "><code class="language-powershell" data-lang="powershell"><span style="color:#96b5b4;">dism.exe </span><span>/online /</span><span style="color:#96b5b4;">enable-feature </span><span>/featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
</span><span style="color:#96b5b4;">dism.exe </span><span>/online /</span><span style="color:#96b5b4;">enable-feature </span><span>/featurename:VirtualMachinePlatform /all /norestart
</span></code></pre>
<p>After that, we need to restart Windows to complete the installation – press the <strong>Restart now</strong> button.</p>
<p>After Windows starts up, go to the Start Menu again and type &quot;power&quot;. Open PowerShell and type <code>wsl --set-default-version 2</code>. After that, download the <a href="https://docs.microsoft.com/en-us/windows/wsl/wsl2-kernel">Linux kernel update for WSL2</a> and install it.</p>
<h3 id="installing-docker-desktop">Installing Docker Desktop</h3>
<p>Download Docker Desktop for Windows from the <a href="https://www.docker.com/products/docker-desktop">official Docker website</a>. After the installation is complete, press <strong>Close and log out</strong>.</p>
<h3 id="installing-ubuntu-20-04">Installing Ubuntu 20.04</h3>
<p>After you log back in, you'll see the Docker Desktop screen. But before configuring docker, we need to install a WSL distro from which we're going to use in order to manage our container. </p>
<p>Open Microsoft Store and search for your favorite distribution. Personally, I recommend <a href="https://www.microsoft.com/en-us/p/ubuntu-2004-lts/9n6svws3rx71">Ubuntu 20.04 LTS</a></p>
<p>Once that's installed, click on &quot;Launch&quot;. Type in your desired username and password in the terminal, and after that you should get the bash prompt. </p>
<p>Now go back to Docker Desktop, open the Settings and untick the &quot;Send usage statistics&quot;. Then, go to Resources &gt; WSL INTEGRATION and enable &quot;Ubuntu 20.04&quot;. Close the Linux terminal window and open it again from the Start menu.</p>
<p><img src="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/img/vpn2/docker.png" alt="Docker Settings" /></p>
<h3 id="creating-folders-and-writing-a-compose-file">Creating folders and writing a compose file</h3>
<p>In the Linux terminal, type:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">mkdir -p</span><span> /mnt/c/Users/WINDOWS_USER_NAME/docker/arch-delugevpn/data
</span><span style="color:#bf616a;">mkdir -p</span><span> /mnt/c/Users/WINDOWS_USER_NAME/docker/arch-delugevpn/config/openvpn
</span><span style="color:#bf616a;">mkdir -p</span><span> /mnt/c/Users/WINDOWS_USER_NAME/docker/arch-delugevpn/config/compose
</span></code></pre>
<p>This will create a folder named <strong>docker</strong> in your Windows user's directory and all the necessary subfolders. </p>
<p>Now create a file named <code>docker-compose.yml</code> in the <strong>compose</strong> folder with the following contents:</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">version</span><span>: &#39;</span><span style="color:#a3be8c;">3</span><span>&#39;
</span><span style="color:#bf616a;">services</span><span>:
</span><span>        </span><span style="color:#bf616a;">delugevpn</span><span>:
</span><span>                </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">delugevpn
</span><span>                </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">binhex/arch-delugevpn:latest
</span><span>                </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">unless-stopped
</span><span>                </span><span style="color:#bf616a;">cap_add</span><span>:
</span><span>                        - </span><span style="color:#a3be8c;">net_admin </span><span style="color:#65737e;"># Necessary for OpenVPN
</span><span>                </span><span style="color:#bf616a;">ports</span><span>:
</span><span>                        - </span><span style="color:#a3be8c;">0.0.0.0:8112:8112
</span><span>                        - </span><span style="color:#a3be8c;">58846:58846
</span><span>                        - </span><span style="color:#a3be8c;">0.0.0.0:8118:8118
</span><span>                </span><span style="color:#bf616a;">environment</span><span>:
</span><span>                        - </span><span style="color:#a3be8c;">VPN_ENABLED=yes
</span><span>                        - </span><span style="color:#a3be8c;">VPN_PROV=custom
</span><span>                        - </span><span style="color:#a3be8c;">VPN_CLIENT=openvpn
</span><span>                        - </span><span style="color:#a3be8c;">ENABLE_PRIVOXY=yes
</span><span>                        - </span><span style="color:#a3be8c;">LAN_NETWORK=192.168.178.0/24 </span><span style="color:#65737e;"># Replace with your network&#39;s IP
</span><span>                        - </span><span style="color:#a3be8c;">NAME_SERVERS=1.1.1.1,1.0.0.1
</span><span>                        - </span><span style="color:#a3be8c;">DELUGE_DAEMON_LOG_LEVEL=info
</span><span>                        - </span><span style="color:#a3be8c;">DELUGE_WEB_LOG_LEVEL=info
</span><span>                        - </span><span style="color:#a3be8c;">DEBUG=false
</span><span>                        - </span><span style="color:#a3be8c;">UMASK=000
</span><span>                        - </span><span style="color:#a3be8c;">PUID=1000
</span><span>                        - </span><span style="color:#a3be8c;">PGID=1000
</span><span>                        - </span><span style="color:#a3be8c;">TZ=Europe/Amsterdam </span><span style="color:#65737e;"># Replace with your timezone – check https://en.wikipedia.org/wiki/List_of_tz_database_time_zones for reference
</span><span>                </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>                        - </span><span style="color:#a3be8c;">/mnt/c/Users/WINDOWS_USER_NAME/docker/arch-delugevpn/data:/data </span><span style="color:#65737e;"># Replace WINDOWS_USER_NAME with your actual username
</span><span>                        - </span><span style="color:#a3be8c;">/mnt/c/Users/WINDOWS_USER_NAME/docker/arch-delugevpn/config:/config
</span><span>                        - </span><span style="color:#a3be8c;">/etc/localtime:/etc/localtime:ro
</span></code></pre>
<p>Some additional information for the parameters:</p>
<ul>
<li><code>VPN_PROV</code> — set it to <code>custom</code> if you're using a self-hosted VPN. There are also some other options, such as <code>pia</code> or <code>airvpn</code>, check out the <a href="https://hub.docker.com/r/binhex/arch-delugevpn">container documentation</a> if you're interested</li>
<li><code>VPN_CLIENT</code> — You can set it either to <code>openvpn</code> or <code>wireguard</code> — once again, I couldn't make Wireguard work on Windows, so I will be using OpenVPN</li>
<li><code>LAN_NETWORK</code> — If you don't know the IP of your LAN network, open a PowerShell window and type <code>ipconfig</code>. Copy the first three numbers from the <code>IPv4 Address</code> field and paste them to the <code>LAN_NETWORK</code> field in the compose file. Append a 0 as the fourth number and add <code>/24</code> at the end.</li>
<li>In the <code>volumes</code> section you need to expose the config and downloads folders, as well as the <strong>localtime</strong> file to the container. The latter will remain the same in any case, no matter which folders you created, but for the first two — put the path to the folder on your local machine on the left and the path in the container on the right. In this case, the container path for <strong>config</strong> folder is <code>/config</code> and the downloads are located in <code>/data/incomplete</code> by default, but you can put them anywhere and change the download path in the torrent client later.</li>
</ul>
<h3 id="running-the-container">Running the container</h3>
<p>Once you're done, save the file and quit. Now we're ready to run our container — type <code>docker-compose up -d</code>. But once that's done — wait for about 10 seconds, and if you did everything correctly you should be able to see <strong>Privoxy process listening on port 8118</strong> when you type <code>docker logs delugevpn</code>. </p>
<h3 id="working-with-deluge">Working with Deluge</h3>
<p>Open a browser and go to localhost:8112. You will get a password prompt and the default password here is &quot;deluge&quot;. You can change it latter in the settings. </p>
<h3 id="privoxy-proxy">Privoxy proxy</h3>
<p>You can now access the proxy by pointing your applications to <code>localhost:8112</code>. Here's an example of what that looks like in Firefox:</p>
<div class="post__image">
    <a href="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/firefox.png" class="image-link" target="_blank">
        <img src="https://notthebe.ee/blog/split-vpn-tunnelling-for-selected-applications/firefox.png" alt="Firefox Network Settings">
    </a>
</div>
<p>Privoxy also features ad/tracker filtering and other functinonality. To access the settings, open <a href="http://config.privoxy.org">http://config.privoxy.org</a> in your browser.
You can also use <a href="https://addons.mozilla.org/en-US/firefox/addon/foxyproxy-standard/">FoxyProxy</a> in Firefox for advanced whitelisting/blacklisting functionality with regular expressions.</p>
<h2 id="linux">Linux</h2>
<p>On Linux this whole process takes less than 5 minutes. Open a terminal and type the following commands:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">sudo</span><span> pacman</span><span style="color:#bf616a;"> -S</span><span> docker docker-compose </span><span style="color:#65737e;"># Will obviously differ depending on the distributin
</span><span style="color:#bf616a;">sudo</span><span> usermod</span><span style="color:#bf616a;"> -aG</span><span> docker username
</span><span style="color:#bf616a;">sudo</span><span> systemctl enable</span><span style="color:#bf616a;"> --now</span><span> docker
</span><span>
</span><span style="color:#bf616a;">mkdir -p</span><span> /home/LINUX_USERNAME/docker/arch-delugevpn/data
</span><span style="color:#bf616a;">mkdir -p</span><span> /home/LINUX_USERNAME/docker/arch-delugevpn/compose
</span><span style="color:#bf616a;">mkdir -p</span><span> /home/LINUX_USERNAME/docker/arch-delugevpn/config/wireguard </span><span style="color:#65737e;"># If you&#39;re using Wireguard
</span><span style="color:#bf616a;">mkdir -p</span><span> /home/LINUX_USERNAME/docker/arch-delugevpn/config/openvpn </span><span style="color:#65737e;"># If you&#39;re using OpenVPN
</span></code></pre>
<p>The <code>docker-compose.yml</code> will look a little bit different for Wireguard. In particular, we need to add the following lines:</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>                </span><span style="color:#bf616a;">privileged</span><span>: </span><span style="color:#d08770;">true
</span><span>                </span><span style="color:#bf616a;">sysctls</span><span>:
</span><span>                        - &quot;</span><span style="color:#a3be8c;">net.ipv4.conf.all.src_valid_mark=1</span><span>&quot;
</span></code></pre>
<p>Now reboot. After booting up you can launch the container by running <code>docker-compose up -d</code></p>
<h2 id="macos">macOS</h2>
<p>On macOS the process is similar to Windows with a few exceptions:</p>
<ul>
<li>Wireguard actually works</li>
<li>Docker Desktop is available in <a href="https://brew.sh/">Homebrew</a> repositories. To install it, type <code>brew cask install docker</code></li>
<li>The performance might be slightly inferior to Windows, since macOS doesn't feature WSL2</li>
</ul>

</div>
    </section>



<footer>
	<p>Generated by <a target="_blank" href="https://www.getzola.org/">Zola</a></p>
</footer>
<script

  src="https://notthebe.ee/darktheme.js?h=4694dd1e43b553665547227c7aba0988568279162707d80d7503e8ece14e8c77"
  crossorigin="anonymous"
></script>

  </body>


</html>
